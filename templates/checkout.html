{% extends 'base.html' %}
{% load static %}

{% block content %}

{% if aviso %}
<div class="bg-amber-50 border-l-4 border-amber-400 p-4 mb-6 rounded-r-xl flex items-center gap-3">
    <i class="bi bi-exclamation-triangle text-amber-500 text-xl"></i>
    <p class="text-amber-800 text-xs font-bold uppercase tracking-tight">
        {{ aviso }}
    </p>
</div>
{% endif %}

{% if erro %}
<div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6 rounded-r-xl flex items-center gap-3">
    <i class="bi bi-x-circle text-red-500 text-xl"></i>
    <p class="text-red-800 text-xs font-bold uppercase tracking-tight">
        {{ erro }}
    </p>
</div>
{% endif %}
<div class="bg-slate-50 min-h-screen py-8 md:py-12 lg:py-20">
    <div class="container mx-auto px-4 max-w-6xl">
        <h1 class="text-2xl md:text-3xl font-[900] text-slate-900 mb-6 md:mb-10 tracking-tight text-center md:text-left">Finalizar Compra</h1>

        <form method="POST" action="{% url 'finalizar_pedido' %}" class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-12">
            {% csrf_token %}

            <div class="lg:col-span-2 space-y-6 md:space-y-8">
                <div class="bg-white p-6 md:p-8 rounded-[1.5rem] md:rounded-[2.5rem] border border-slate-100 shadow-sm">
                    <h3 class="font-black text-xs md:text-sm uppercase tracking-widest text-slate-400 mb-6 md:mb-8 flex items-center gap-3">
                        <span class="w-7 h-7 md:w-8 md:h-8 bg-primary-teal text-white rounded-full flex items-center justify-center text-[10px] md:text-xs">1</span>
                        Endereço de Entrega
                    </h3>

                    <div class="space-y-4 md:space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black uppercase text-slate-500 ml-2">País/Região</label>
                                <select name="pais" class="w-full bg-slate-50 border-none rounded-xl md:rounded-2xl py-3 md:py-4 px-5 md:px-6 focus:ring-2 focus:ring-primary-teal text-sm font-bold">
                                    {% for pais in lista_paises %}
                                        <option value="{{ pais }}" {% if pais == "Brasil" %}selected{% endif %}>{{ pais }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black uppercase text-slate-500 ml-2">Nome Completo</label>
                                <input type="text" name="nome" required placeholder="Nome e Sobrenome" class="w-full bg-slate-50 border-none rounded-xl md:rounded-2xl py-3 md:py-4 px-5 md:px-6 focus:ring-2 focus:ring-primary-teal text-sm">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black uppercase text-slate-500 ml-2">E-mail</label>
                                <input type="email" name="email" required placeholder="seu@email.com" class="w-full bg-slate-50 border-none rounded-xl md:rounded-2xl py-3 md:py-4 px-5 md:px-6 focus:ring-2 focus:ring-primary-teal text-sm">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black uppercase text-slate-500 ml-2">Telefone</label>
                                <input type="text" name="telefone" id="id_telefone" required minlength="14" placeholder="(47) 99999-9999" class="w-full bg-slate-50 border-none rounded-xl md:rounded-2xl py-3 md:py-4 px-5 md:px-6 focus:ring-2 focus:ring-primary-teal text-sm">
                            </div>
                        </div>

                        <div class="space-y-2">
                            <label class="text-[10px] font-black uppercase text-slate-500 ml-2">CEP</label>
                            <input type="text" name="cep" id="id_cep" required placeholder="00000-000" class="w-full bg-slate-50 border-none rounded-xl md:rounded-2xl py-3 md:py-4 px-5 md:px-6 focus:ring-2 focus:ring-primary-teal text-sm">
                        </div>

                        <div class="space-y-2">
                            <label class="text-[10px] font-black uppercase text-slate-500 ml-2">Endereço e Número</label>
                            <input type="text" name="endereco" required placeholder="Rua, Avenida, Número..." class="w-full bg-slate-50 border-none rounded-xl md:rounded-2xl py-3 md:py-4 px-5 md:px-6 focus:ring-2 focus:ring-primary-teal text-sm">
                        </div>
                        <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase text-slate-500 ml-2">CPF</label>
                        <input type="text" name="cpf" id="id_cpf" required placeholder="000.000.000-00"
                            class="w-full bg-slate-50 border-none rounded-xl md:rounded-2xl py-3 md:py-4 px-5 md:px-6 focus:ring-2 focus:ring-primary-teal text-sm">
                    </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black uppercase text-slate-500 ml-2">Bairro</label>
                                <input type="text" name="bairro" required class="w-full bg-slate-50 border-none rounded-xl md:rounded-2xl py-3 md:py-4 px-5 md:px-6 focus:ring-2 focus:ring-primary-teal text-sm">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black uppercase text-slate-500 ml-2">Cidade</label>
                                <input type="text" name="cidade" required class="w-full bg-slate-50 border-none rounded-xl md:rounded-2xl py-3 md:py-4 px-5 md:px-6 focus:ring-2 focus:ring-primary-teal text-sm">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black uppercase text-slate-500 ml-2">Estado</label>
                                <input type="text" name="estado" required placeholder="Ex: SC" class="w-full bg-slate-50 border-none rounded-xl md:rounded-2xl py-3 md:py-4 px-5 md:px-6 focus:ring-2 focus:ring-primary-teal text-sm">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 md:p-8 rounded-[1.5rem] md:rounded-[2.5rem] border border-slate-100 shadow-sm">
                    <h3 class="font-black text-xs md:text-sm uppercase tracking-widest text-slate-400 mb-6 md:mb-8 flex items-center gap-3">
                        <span class="w-7 h-7 md:w-8 md:h-8 bg-primary-teal text-white rounded-full flex items-center justify-center text-[10px] md:text-xs">2</span>
                        Método de Pagamento
                    </h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                    <label class="relative flex items-center gap-4 p-5 md:p-6 border-2 border-slate-100 rounded-2xl md:rounded-3xl cursor-pointer hover:border-primary-teal/30 transition">
                        <input type="radio" name="pagamento" value="pix" checked class="w-5 h-5 text-primary-teal">
                        <div>
                            <p class="font-black text-slate-900 text-xs md:text-sm">PIX (Aprovação Instantânea)</p>
                            <p class="text-[9px] md:text-[10px] text-emerald-500 font-bold uppercase">5% de Desconto</p>
                        </div>
                    </label>

                    <label class="relative flex items-center gap-4 p-5 md:p-6 border-2 border-slate-100 rounded-2xl md:rounded-3xl cursor-pointer hover:border-primary-teal/30 transition">
                        <input type="radio" name="pagamento" value="cartao" class="w-5 h-5 text-primary-teal">
                        <div>
                            <p class="font-black text-slate-900 text-xs md:text-sm">Cartão de Crédito</p>
                            <p class="text-[9px] md:text-[10px] text-slate-400 font-bold uppercase">Em até 12x</p>
                        </div>
                    </label>

                    <label class="relative flex items-center gap-4 p-5 md:p-6 border-2 border-slate-100 rounded-2xl md:rounded-3xl cursor-pointer hover:border-primary-teal/30 transition">
                        <input type="radio" name="pagamento" value="debito" class="w-5 h-5 text-primary-teal">
                        <div>
                            <p class="font-black text-slate-900 text-xs md:text-sm">Cartão de Débito</p>
                        </div>
                    </label>
                </div>
                </div>
            </div>

            <div class="lg:col-span-1">
                <div class="bg-white p-6 md:p-8 rounded-[1.5rem] md:rounded-[2.5rem] border border-slate-100 shadow-sm lg:sticky lg:top-24">
                    <h4 class="font-black text-[10px] md:text-xs uppercase tracking-widest text-slate-400 mb-6">Resumo do Pedido</h4>
                    <div class="space-y-4 mb-8">
                        {% for item in itens %}
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-slate-50 rounded-xl overflow-hidden border border-slate-100 flex-shrink-0">
                                <img src="{{ item.produto.imagem.url }}" class="w-full h-full object-contain">
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-[11px] font-bold text-slate-900 truncate">{{ item.produto.nome }}</p>
                                <p class="text-[9px] font-black text-slate-400 uppercase">Qtd: {{ item.quantidade }}</p>
                            </div>
                            <p class="text-xs font-black text-slate-900">R$ {{ item.subtotal|floatformat:2 }}</p>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="space-y-4 pt-6">
    <div class="flex justify-between items-center">
        <span class="text-slate-500 font-medium">Subtotal</span>
        <span class="text-slate-900 font-bold">R$ {{ total_carrinho_lateral|floatformat:2 }}</span>
    </div>

            <div class="flex justify-between items-center">
                <span class="text-slate-500 font-medium">Frete</span>
                <div class="text-right">
                    <span id="frete-valor" class="text-emerald-500 font-black uppercase text-xs">Grátis para todo o Brasil</span>
                    <p class="text-[9px] text-slate-400 font-bold uppercase tracking-tighter">Envio Internacional (15-25 dias)</p>
                </div>
            </div>

            <div class="border-t border-dashed border-slate-200 pt-4 flex justify-between items-center">
                <span class="text-lg font-black text-slate-900 uppercase">Total</span>
                <span id="total-final" class="text-2xl font-[900] text-primary-teal tracking-tighter">
                R$ {{ total_carrinho_lateral|floatformat:2 }}
                </span>
            </div>
        </div>
                    <button type="submit" class="w-full bg-amazon-orange text-white py-4 md:py-5 rounded-xl md:rounded-2xl font-[900] uppercase text-[11px] md:text-xs shadow-xl shadow-orange-500/30 hover:scale-[1.02] transition-all mt-8">
                        Finalizar Pedido
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
<script>
    // 1. FUNÇÕES DE UTILIDADE (Mantidas conforme funcionam)
    function copyPixCode() {
        const input = document.getElementById('pix-copy-paste');
        if (input) {
            input.select();
            document.execCommand('copy');
            const successMsg = document.getElementById('copy-success');
            if (successMsg) {
                successMsg.classList.remove('hidden');
                setTimeout(() => successMsg.classList.add('hidden'), 2000);
            }
        }
    }

    // 2. MÁSCARAS DE ENTRADA (Mantidas conforme funcionam)
    document.getElementById('id_telefone').addEventListener('input', function (e) {
        let x = e.target.value.replace(/\D/g, '').match(/(\d{0,2})(\d{0,5})(\d{0,4})/);
        e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
    });

    document.getElementById('id_cep').addEventListener('input', function (e) {
        let x = e.target.value.replace(/\D/g, '').match(/(\d{0,5})(\d{0,3})/);
        e.target.value = x[1] + (x[2] ? '-' + x[2] : '');
    });

    document.getElementById('id_cpf').addEventListener('input', function (e) {
        let x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,3})(\d{0,2})/);
        e.target.value = !x[2] ? x[1] : x[1] + '.' + x[2] + (x[3] ? '.' + x[3] : '') + (x[4] ? '-' + x[4] : '');
    });

    // 3. LÓGICA DE PREÇO E DESCONTO (Organizada e Corrigida)

    // Armazenamos o valor original vindo do servidor
    const valorOriginalServidor = parseFloat("{{ total_carrinho_lateral }}".replace(',', '.'));

    function atualizarPrecoVisual() {
        const totalElement = document.getElementById('total-final');
        if (!totalElement) return;

        const metodoChecked = document.querySelector('input[name="pagamento"]:checked');
        let totalExibicao = valorOriginalServidor;

        // Se o frete é sempre grátis, o total base é sempre o valor original dos produtos
        if (metodoChecked && metodoChecked.value === 'pix') {
            totalExibicao = valorOriginalServidor * 0.95; // Aplica 5% de desconto
        }

        totalElement.innerText = `R$ ${totalExibicao.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        })}`;
    }

    // 4. LÓGICA DE FRETE SEMPRE GRÁTIS
    document.getElementById('id_cep').addEventListener('blur', function() {
        const cep = this.value.replace(/\D/g, '');
        if (cep.length === 8) {
            const freteElement = document.getElementById('frete-valor');
            // Como o frete é sempre grátis, apenas confirmamos visualmente
            if (freteElement) {
                freteElement.innerText = "Grátis";
                freteElement.classList.add('text-emerald-500', 'font-black');
            }
            // Chamamos a atualização de preço para garantir que o desconto do PIX continue visível
            atualizarPrecoVisual();
        }
    });

    // 5. EVENTOS DE INICIALIZAÇÃO
    document.querySelectorAll('input[name="pagamento"]').forEach(radio => {
        radio.addEventListener('change', atualizarPrecoVisual);
    });

    // Garante que o valor com desconto apareça assim que a página carregar
    document.addEventListener('DOMContentLoaded', atualizarPrecoVisual);
</script>

{% endblock %}